{% extends 'base.html' %}

{% block header %}
    {% block title %}Live{% endblock %}
{% endblock %}

{% block content %}
    <div class="w3-row w3-border">
        <div class="w3-half">
            <img src="{{ url_for('home.video_feed') }}" class="w3-image">
        </div>
        <div class="w3-half">
            <div class="w3-bar w3-green">
                <button class="w3-bar-item w3-button" onclick="openCtrlTab('focus')">Focus</button>
                <button class="w3-bar-item w3-button" onclick="openCtrlTab('zoom')">Zoom</button>
                <button class="w3-bar-item w3-button" onclick="openCtrlTab('autoexposure')">Auto-Exposure</button>
                <button class="w3-bar-item w3-button" onclick="openCtrlTab('exposure')">Exposure</button>
                <button class="w3-bar-item w3-button" onclick="openCtrlTab('image')">Image</button>
            </div>
            {% if sc.lastLiveTab == "focus" %}
            <div id="focus" class="w3-container controlgroup">
            {% else %}
            <div id="focus" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <h4>Focus handling</h4>
                {% if cp.hasFocus %}
                <div>
                    <form method="post" action="{{ url_for('home.focus_control') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The autofocus mode.
                                    </span>
                                    <label for="afmode">Autofocus Mode:</label>
                                </td>
                                <td>
                                    <select name="afmode" id="afmode">
                                        {% if cc.afMode == 0 %}
                                        <option value="0" selected>Manual</option>
                                        {% else %}
                                        <option value="0">Manual</option>
                                        {% endif %}
                                        {% if cc.afMode == 1 %}
                                        <option value="1" selected>Auto</option>
                                        {% else %}
                                        <option value="1">Auto</option>
                                        {% endif %}
                                        {% if cc.afMode == 2 %}
                                        <option value="2" selected>Continuous</option>
                                        {% else %}
                                        <option value="2">Continuous</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The focal distance in m. <br>(pressing Enter will automatially submit)
                                    </span>
                                    <label for="fdist">Focal Distance [m]:</label>
                                </td>
                                <td>
                                    <input type="number" id="fdist" name="fdist" min="0.01" max="999" step="0.01" value={{ cc.focalDistance }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Specifies where focus should be measured.
                                    </span>
                                    <label for="afmetering">Autofocus Metering:</label>
                                </td>
                                <td>
                                    <select name="afmetering" id="afmetering">
                                        {% if cc.afMetering == 0 %}
                                        <option value="0" selected>Auto</option>
                                        {% else %}
                                        <option value="0">Auto</option>
                                        {% endif %}
                                        {% if cc.afMetering == 1 %}
                                        <option value="1" selected>Windows</option>
                                        {% else %}
                                        <option value="1">Windows</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Pause continuous autofocus. Only has any effect when in continuous autofocus mode.
                                    </span>
                                    <label for="afpause">Autofocus Pause:</label>
                                </td>
                                <td>
                                    <select name="afpause" id="afpause">
                                        {% if cc.afPause == 0 %}
                                        <option value="0" selected>Immediate</option>
                                        {% else %}
                                        <option value="0">Immediate</option>
                                        {% endif %}
                                        {% if cc.afPause == 1 %}
                                        <option value="1" selected>Deferred</option>
                                        {% else %}
                                        <option value="1">Deferred</option>
                                        {% endif %}
                                        {% if cc.afPause == 2 %}
                                        <option value="2" selected>Resume</option>
                                        {% else %}
                                        <option value="2">Resume</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <label for="afrange">Autofocus Range:</label>
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Range of lens positions to search.
                                    </span>
                                </td>
                                <td>
                                    <select name="afrange" id="afrange">
                                        {% if cc.afRange == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.afRange == 1 %}
                                        <option value="1" selected>Macro</option>
                                        {% else %}
                                        <option value="1">Macro</option>
                                        {% endif %}
                                        {% if cc.afRange == 2 %}
                                        <option value="2" selected>Full</option>
                                        {% else %}
                                        <option value="2">Full</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <label for="afspeed">Autofocus Speed:</label>
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Speed of the autofocus search.
                                    </span>
                                </td>
                                <td>
                                    <select name="afspeed" id="afspeed">
                                        {% if cc.afSpeed == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.afSpeed == 1 %}
                                        <option value="1" selected>Fast</option>
                                        {% else %}
                                        <option value="1">Fast</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                        </table>
                        <br>
                        <input class="w3-button w3-black" type="submit" value="Submit">
                    </form>
                    <br>
                    <form method="post" action="{{ url_for('home.trigger_autofocus') }}">
                        <input class="w3-button w3-black" type="submit" value="Trigger Autofocus">
                    </form>
                </div>
                {% else %}
                <p>Not available for this camera</p>
                {% endif %}
            </div>
            {% if sc.lastLiveTab == "zoom" %}
            <div id="zoom" class="w3-container controlgroup">
            {% else %}
            <div id="zoom" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <h4>Zoom and pan</h4>
                <div>
                    <form method="post" action="{{ url_for('home.set_zoom') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The current zoom factor in %
                                    </span>
                                    <label for="zoomfactor">Current zoom factor in %:</label>
                                </td>
                                <td>
                                    <input type="number" id="zoomfactor" name="zoomfactor" value={{ sc.zoomFactor }} disabled>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The increment or decrement (in %) by which the zoom factor will be modified in each step
                                    </span>
                                    <label for="zoomfactorstep">Zoom & pan step in %:</label>
                                </td>
                                <td>
                                    <input type="number" id="zoomfactorstep" name="zoomfactorstep" value={{ sc.zoomFactorStep }} min="2" max="20">
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The scaler crop rectangle determines which part of the image received from the sensor is
                                        cropped and then scaled to produce an output image of the correct size.
                                        (x_offset, y_offset, width, height)
                                    </span>
                                    <label for="scalercrop">Current ScalerCrop:</label>
                                </td>
                                <td>
                                    <input type="text" id="scalercrop" name="scalercrop" value={{ cc.scalerCropStr }} disabled>
                                </td>
                            </tr>
                        </table>
                        <input class="w3-button w3-black" style ="display:none" type="submit" value="Submit">
                    </form>
                    <br>
                    <table class="w3-table">
                        <tr>
                            <td>
                                <form method="post" action="{{ url_for('home.zoom_in') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Zoom in">
                                </form>
                            </td>
                            <td>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_up') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan up">
                                </form>
                            </td>
                            <td>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <form method="post" action="{{ url_for('home.zoom_out') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Zoom out">
                                </form>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_left') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan left">
                                </form>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_center') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Center">
                                </form>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_right') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan right">
                                </form>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <form method="post" action="{{ url_for('home.zoom_full') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Full">
                                </form>
                            </td>
                            <td>
                            </td>
                            <td>
                                <form method="post" action="{{ url_for('home.pan_down') }}">
                                    <input class="w3-button w3-black" style="width:80%" type="submit" value="Pan down">
                                </form>
                            </td>
                            <td>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            {% if sc.lastLiveTab == "autoexposure" %}
            <div id="autoexposure" class="w3-container controlgroup">
            {% else %}
            <div id="autoexposure" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <h4>Auto Exposure</h4>
                <div>
                    <form method="post" action="{{ url_for('home.ae_control') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Enable or disable the Automatic Exposure (AE).
                                    </span>
                                    <label for="aeenable">AE enabled:</label>
                                </td>
                                <td>
                                    {% if cc.aeEnable == True%}
                                    <input type="checkbox" id="aeenable" name="aeenable" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="aeenable" name="aeenable" value="0">
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the metering mode of the algorithm for 
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aemeteringmode">AEC/AGC Metering Mode:</label>
                                </td>
                                <td>
                                    <select name="aemeteringmode" id="aemeteringmode">
                                        {% if cc.aeMeteringMode == 0 %}
                                        <option value="0" selected>Center Weighted</option>
                                        {% else %}
                                        <option value="0">Center Weighted</option>
                                        {% endif %}
                                        {% if cc.aeMeteringMode == 1 %}
                                        <option value="1" selected>Spot</option>
                                        {% else %}
                                        <option value="1">Spot</option>
                                        {% endif %}
                                        {% if cc.aeMeteringMode == 2 %}
                                        <option value="2" selected>Matrix</option>
                                        {% else %}
                                        <option value="2">Matrix</option>
                                        {% endif %}
                                        {% if cc.aeMeteringMode == 3 %}
                                        <option value="3" selected>Custom</option>
                                        {% else %}
                                        <option value="3">Custom</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the constraint mode of the algorithm for 
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aeexposuremode">AEC/AGC Exposure Mode:</label>
                                </td>
                                <td>
                                    <select name="aeexposuremode" id="aeexposuremode">
                                        {% if cc.aeExposureMode == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.aeExposureMode == 1 %}
                                        <option value="1" selected>Short</option>
                                        {% else %}
                                        <option value="1">Short</option>
                                        {% endif %}
                                        {% if cc.aeExposureMode == 2 %}
                                        <option value="2" selected>Long</option>
                                        {% else %}
                                        <option value="2">Long</option>
                                        {% endif %}
                                        {% if cc.aeExposureMode == 3 %}
                                        <option value="3" selected>Custom</option>
                                        {% else %}
                                        <option value="3">Custom</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the constraint mode of the algorithm for 
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aeconstraintmode">AEC/AGC Constraint Mode:</label>
                                </td>
                                <td>
                                    <select name="aeconstraintmode" id="aeconstraintmode">
                                        {% if cc.aeConstraintMode == 0 %}
                                        <option value="0" selected>Normal</option>
                                        {% else %}
                                        <option value="0">Normal</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 1 %}
                                        <option value="1" selected>Highlight</option>
                                        {% else %}
                                        <option value="1">Highlight</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 2 %}
                                        <option value="2" selected>Shadows</option>
                                        {% else %}
                                        <option value="2">Shadows</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 3 %}
                                        <option value="3" selected>Custom</option>
                                        {% else %}
                                        <option value="3">Custom</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the flicker avoidance mode of the algorithm for
                                        automatic gain control (AGC) and automatic exposure control (AEC).
                                    </span>
                                    <label for="aeflickermode">AEC/AGC Flicker Mode:</label>
                                </td>
                                <td>
                                    <select name="aeflickermode" id="aeflickermode">
                                        {% if cc.aeFlickerMode == 0 %}
                                        <option value="0" selected>Off</option>
                                        {% else %}
                                        <option value="0">Off</option>
                                        {% endif %}
                                        {% if cc.aeFlickerMode == 1 %}
                                        <option value="1" selected>Manual</option>
                                        {% else %}
                                        <option value="1">Manual</option>
                                        {% endif %}
                                        {% if cc.aeFlickerMode == 2 %}
                                        <option value="2" selected>Auto</option>
                                        {% else %}
                                        <option value="2">Auto</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Sets the lighting flicker period in microseconds.<br>
                                        For example, for 50Hz mains lighting the flicker occurs at 100Hz, 
                                        so the period would be 10000 microseconds
                                    </span>
                                    <label for="aeflickerperiod">AEC/AGC Flicker Period:</label>
                                </td>
                                <td>
                                    <input type="number" id="aeflickerperiod" name="aeflickerperiod" min="0" value={{ cc.aeFlickerPeriod }}>
                                </td>
                            </tr>
                        </table>
                        <br>
                        <input class="w3-button w3-black" type="submit" value="Submit">
                    </form>
                </div>
            </div>
            {% if sc.lastLiveTab == "exposure" %}
            <div id="exposure" class="w3-container controlgroup">
            {% else %}
            <div id="exposure" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <h4>Exposure</h4>
                <div>
                    <form method="post" action="{{ url_for('home.exposure_control') }}">
                        <table class="w3-table-all">
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Exposure time (shutter speed) in sec. <br>A value of 0 will activate AE.
                                    </span>
                                    <label for="exposuretimesec">Exposure Time in sec:</label>
                                </td>
                                <td>
                                    <input type="number" id="exposuretimesec" name="exposuretimesec" min="0.0" max="999" step="0.000001" value={{ cc.exposureTimeSec }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Exposure compensation value in "stops", 
                                        which adjusts the target of the AEC/AGC algorithm.
                                        Positive values increase the target brightness,
                                        and negative values decrease it.<br>
                                        Zero represents the base or "normal" exposure level.
                                    </span>
                                    <label for="exposurevalue">Exposure Value:</label>
                                </td>
                                <td>
                                    <input type="number" id="exposurevalue" name="exposurevalue" min="-8.0" max="8.0" step="0.1" value={{ cc.exposureValue }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Analogue gain applied by the sensor
                                    </span>
                                    <label for="analoguegain">Analogue Gain:</label>
                                </td>
                                <td>
                                    <input type="number" id="analoguegain" name="analoguegain" min="1.0" max="99.0" step="0.1" value={{ cc.analogueGain }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Red colour gain. The gain applied to red pixels 
                                        by the Automatic White Balance algorithm (AWB)
                                    </span>
                                    <label for="colourgainred">Colour Gain (Red):</label>
                                </td>
                                <td>
                                    <input type="number" id="colourgainred" name="colourgainred" min="0.0" max="32.0" step="0.1" value={{ cc.colourGainRed }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Blue colour gain. The gain applied to blue pixels
                                        by the Automatic White Balance algorithm (AWB)
                                    </span>
                                    <label for="colourgainblue">Colour Gain (Blue):</label>
                                </td>
                                <td>
                                    <input type="number" id="colourgainblue" name="colourgainblue" min="0.0" max="32.0" step="0.1" value={{ cc.colourGainBlue }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The maximum time that the
                                        sensor can take to deliver a frame, measured
                                        in microseconds. So the reciprocal of this
                                        value (first divided by 1000000) will give the
                                        minimum framerate that the sensor can deliver.<br>
                                        A value of 0 reverts to using the camera default.
                                    </span>
                                    <label for="framedurationlimitmax">Frame Duration Limit Max (μs):</label>
                                </td>
                                <td>
                                    <input type="number" id="framedurationlimitmax" name="framedurationlimitmax" 
                                        min="0" step="1" value={{ cc.frameDurationLimitMax }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        The minimum time that the
                                        sensor can take to deliver a frame, measured
                                        in microseconds. So the reciprocal of this
                                        value (first divided by 1000000) will give the
                                        macimum framerate that the sensor can deliver.<br>
                                        A value of 0 reverts to using the camera default.
                                    </span>
                                    <label for="framedurationlimitmin">Frame Duration Limit Min (μs):</label>
                                </td>
                                <td>
                                    <input type="number" id="framedurationlimitmin" name="framedurationlimitmin" 
                                        min="0" step="1" value={{ cc.frameDurationLimitMin }}>
                                </td>
                            </tr>
                            <tr>
                                <td class="w3-tooltip">
                                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                        Whether to run the camera in an HDR mode
                                        (distinct from the in-camera HDR supported by
                                        the Camera Module 3). Most of these HDR
                                        features work only on Pi 5 or later devices.
                                    </span>
                                    <label for="hdrmode">HDR Mode:</label>
                                </td>
                                <td>
                                    <select name="hdrmode" id="hdrmode">
                                        {% if cc.hdrMode == 0 %}
                                        <option value="0" selected>Off</option>
                                        {% else %}
                                        <option value="0">Off</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 1 %}
                                        <option value="1" selected>MultiExposureUnmerged</option>
                                        {% else %}
                                        <option value="1">MultiExposureUnmerged</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 2 %}
                                        <option value="2" selected>MultiExposure</option>
                                        {% else %}
                                        <option value="2">MultiExposure</option>
                                        {% endif %}
                                        {% if cc.aeConstraintMode == 3 %}
                                        <option value="3" selected>SingleExposure</option>
                                        {% else %}
                                        <option value="3">SingleExposure</option>
                                        {% endif %}
                                    </select>
                                </td>
                            </tr>
                        </table>
                        <br>
                        <input class="w3-button w3-black" type="submit" value="Submit">
                    </form>
                </div>
            </div>
            {% if sc.lastLiveTab == "image" %}
            <div id="image" class="w3-container controlgroup" style="display:none">
            {% else %}
            <div id="image" class="w3-container controlgroup" style="display:none">
            {% endif %}
                <h4>Image</h4>
            </div>
        </div>
    </div>
    <div class="w3-row w3-border">
        <div class="w3-half">
            <p> </p>
            <form class="w3-container" method="post" action="{{ url_for('home.take_image') }}">
                <label for="filepath">File Path</label>
                <input class="w3-input" name="filepath" id="filepath" value = "{{ ip }}">
                <p></p>
                <label for="filename">File Name (leave empty for automatic naming)</label>
                <input class="w3-input" name="filename" id="filename">
                <p> </p>
                <input class="w3-button w3-black" type="submit" value="Photo">
            </form>
            <p> </p>
        </div>
        <div class="w3-half">
            <p></p>
        </div>
    </div>
    <script>
        function openCtrlTab(ctrlTabName) {
            var i;
            var x = document.getElementsByClassName("controlgroup");
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }
            document.getElementById(ctrlTabName).style.display = "block";
        }
    </script>

{% endblock %}